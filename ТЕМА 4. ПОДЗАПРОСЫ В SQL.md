**ТЕМА 4. ПОДЗАПРОСЫ В SQL**

1. **Введение в SQL подзапросы**

SQL подзапросы - это мощный инструмент в языке SQL, который позволяет выполнять операции на основе результатов других SQL запросов. Они позволяют вам создавать более сложные запросы, комбинируя данные из разных таблиц или выполняя операции над подмножествами данных. В этой лекции рассмотрены основные виды SQL подзапросов в PostgreSQL: WHERE EXISTS и подзапросы с квантификаторами ANY и ALL.

Примеры SQL запросов

Пример: Выборка компаний и имен заказчиков

SELECT company\_name

FROM suppliers

WHERE country IN (SELECT country FROM customers)

-- Эквивалентный запрос с использованием JOIN

SELECT DISTINCT suppliers.company\_name

FROM suppliers

JOIN customers USING(country)

Пример: Суммирование товаров по категориям и использование подзапроса в LIMIT

SELECT category\_name, SUM(units\_in\_stock)

FROM products

INNER JOIN categories ON products.category\_id = categories.category\_id

GROUP BY category\_name

ORDER BY SUM(units\_in\_stock) DESC

LIMIT (SELECT MIN(product\_id) + 4 FROM products)

Пример: Вычисление среднего количества товаров в наличии и выбор товаров, у которых количество в наличии больше среднего

-- Среднее количество товаров в наличии

SELECT AVG(units\_in\_stock)

FROM products

-- Выбор товаров, у которых количество в наличии больше среднего

SELECT product\_name, units\_in\_stock

FROM products

WHERE units\_in\_stock > (SELECT AVG(units\_in\_stock) FROM products)

ORDER BY units\_in\_stock

1. **WHERE EXISTS**

WHERE EXISTS - это условие, которое используется для проверки наличия результатов подзапроса. Если подзапрос возвращает хотя бы одну строку, то условие WHERE EXISTS истинно, и соответствующая строка из основного запроса будет выбрана.

Пример: Выбор компаний и имен заказчиков, которые делали заказы в определенный период

-- Выбор компаний и имен заказчиков, которые делали заказы весом от 50 до 100

SELECT company\_name, contact\_name

FROM customers

WHERE EXISTS (SELECT customer\_id FROM orders

`             `WHERE customer\_id = customers.customer\_id AND

`             `freight BETWEEN 50 AND 100);

-- Выбор компаний и имен заказчиков, которые делали заказы между определенными датами

SELECT company\_name, contact\_name

FROM customers

WHERE EXISTS (SELECT customer\_id FROM orders

`             `WHERE customer\_id = customers.customer\_id AND

`              `orderdate BETWEEN '1995-02-01' AND '1995-02-15');

-- Выбор компаний и имен заказчиков, которые НЕ делали заказы в определенный период

SELECT companyname, contactname
FROM customers
WHERE NOT EXISTS (SELECT customer\_id FROM orders
`              `WHERE customerid = customers.customerid AND
`               `orderdate BETWEEN '1995-02-01' AND '1995-02-15');

1. **Подзапросы с квантификаторами ANY и ALL**

Подзапросы с квантификаторами ANY и ALL позволяют сравнивать значение из основного запроса с набором значений, возвращаемых подзапросом.

Пример: Выбор компаний заказчиков, которые сделали заказы на более чем 40 единиц товаров

-- С использованием JOIN

SELECT DISTINCT company\_name

FROM customers

JOIN orders USING(customer\_id)

JOIN order\_details USING(order\_id)

WHERE quantity > 40;

-- С использованием подзапроса и квантификатора ANY

SELECT DISTINCT company\_name

FROM customers

WHERE customer\_id = ANY(SELECT customer\_id FROM orders

`                      `JOIN order\_details USING(order\_id)

`                      `WHERE quantity > 40);

Пример: Выбор товаров, количество которых больше среднего по заказам

-- Среднее количество товаров в заказах

SELECT AVG(quantity)

FROM order\_details;

-- Выбор товаров, количество которых больше среднего

SELECT DISTINCT product\_name, quantity

FROM products

JOIN order\_details USING(product\_id)

WHERE quantity > (SELECT AVG(quantity) FROM order\_details);

Пример: Выбор товаров, количество которых больше среднего значения по каждой категории товаров

-- Среднее количество товаров в заказах, сгруппированных по product\_id

SELECT AVG(quantity)

FROM order\_details

GROUP BY product\_id;

-- Выбор товаров, количество которых больше среднего значения по каждой категории товаров SELECT DISTINCT product\_name, quantity

FROM products

JOIN order\_details USING(product\_id)

WHERE quantity > ALL

`     `(SELECT AVG(quantity)

`      `FROM order\_details

`      `GROUP BY product\_id)

ORDER BY quantity;
